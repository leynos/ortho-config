# Design for Improved Missing Value Error Messages

This design focuses on replacing the generic `figment::Error` for missing
fields with a custom, helpful error message that guides the user on how to fix
the problem.

## 1. The New Error Message Format

When one or more required configuration values are missing, the application
should exit with a clear, actionable error message. The proposed format is:

```plaintext
Error: Missing required configuration for `my-program`

The following value(s) are missing:
  - `reference`
  - `database.host`

Please provide them using one of the following methods, in order of precedence:

  1. Command-Line Argument:
     --reference <value>
     --database-host <value>

  2. Environment Variable:
     MY_APP_REFERENCE=<value>
     MY_APP_DATABASE__HOST=<value>

  3. Configuration File (e.g., .my_app.toml):
     reference = "<value>"

     [database]
     host = "<value>"
```

This format addresses all the requirements:

- **Context**: It includes the program name.

- **Clarity**: It explicitly lists the missing fields.

- **Guidance**: It shows the user exactly how to provide the missing values.

- **Precedence**: It orders the methods by their precedence.

- **Consolidation**: It presents all missing values in a single, clean message.

## 2. Proposed Changes to `OrthoError`

To support this new error message, a new variant should be added to the
`OrthoError` enum in `ortho_config/src/error.rs`. This separates the "missing
value" case from other gathering errors, allowing for custom formatting.

```rust
// in ortho_config/src/error.rs

use thiserror::Error;

#[derive(Debug, Error)]
#[non_exhaustive]
pub enum OrthoError {
    // … existing variants

    #[error("{0}")]
    MissingRequiredValues(String), // New variant for the formatted error message
}
```

## 3. Implementation Design

The core of this change lies in the `load_from_iter` function generated by the
`OrthoConfig` derive macro. Instead of calling `fig.extract()` and letting it
fail with a `MissingField` error, the implementation pre-emptively checks for
missing values.

### 3.1. Identifying Missing Fields

After merging all configuration sources into the final `Figment` instance but
*before* calling `extract()`, the implementation should iterate over the fields
of the user's configuration struct. For each field that isn't an `Option<T>`,
it should check if a value for that field exists in the `Figment` instance.

The `figment::Figment` struct does not have a public API to list all keys it
knows about, but the code iterates through the fields of the target struct and
checks for their presence in the `Figment` instance. This can be done by
attempting to extract each field individually.

A helper function can be created to recursively walk the struct definition and
build a list of required field paths (e.g., `"reference"`, `"database.host"`).

### 3.2. Generating the Error Message

If any required fields are missing, the implementation will not proceed to the
final `extract()` call. Instead, it will:

1. **Collect all missing field paths**: This will create a list like
   `["reference", "database.host"]`.

2. **Get the program name**: This can be retrieved from
   `std::env::args().next()`.

3. **Get the environment variable prefix**: This is available from the
   `#[ortho_config(prefix = "…")]` attribute.

4. **Format the error message**: Using the template from section 1, it will
   dynamically generate the CLI flags (by replacing underscores with hyphens,
   i.e., not fully kebab-case), environment variables (using the prefix and
   converting to `UPPER_SNAKE_CASE`), and TOML keys.

5. **Return the new error**: The formatted string will be wrapped in the
   `OrthoError::MissingRequiredValues` variant and returned.

This approach ensures that all missing fields are reported at once, providing a
complete picture to the user.

## 4. Implementation Roadmap

Here is a sequence of achievable tasks to implement this capability.

### Task 1: Introduce the New `OrthoError` Variant

- **Objective**: Add the `MissingRequiredValues(String)` variant to the
  `OrthoError` enum.

- **File to Modify**: `ortho_config/src/error.rs`.

- **Acceptance Criteria**: The new variant exists, and the crate compiles.

### Task 2: Implement Pre-flight Check for a Single Missing Field

- **Objective**: Modify the `load_from_iter` implementation in the derive macro
  to check for missing fields before calling `extract()`. For this task, only
  handle the first missing field found.

- **Files to Modify**: `ortho_config_macros/src/derive/load_impl.rs`.

- **Details**:

  - After the `merge_section` but before `fig.extract()`, iterate through the
    struct's fields.

  - For each required field, use `fig.find_value(&path)` to check if the key
    exists.

  - If a key is missing, format a basic error message and return
    `Err(OrthoError::MissingRequiredValues(…))`.

  - This will likely require adding `serde::Deserialize` as a trait bound on
    the user's struct to inspect its fields.

### Task 3: Aggregate All Missing Fields

- **Objective**: Extend the pre-flight check to identify *all* missing required
  fields, not just the first one.

- **File to Modify**: `ortho_config_macros/src/derive/load_impl.rs`.

- **Details**:

  - Create a `Vec<String>` to store the paths of all missing fields.

  - Iterate through all required fields and populate this vector.

  - If the vector is not empty after checking all fields, then generate the
    error.

### Task 4: Generate the Full, User-Friendly Error Message

- **Objective**: Implement the logic to format the detailed error message as
  designed in section 1.

- **File to Modify**: `ortho_config_macros/src/derive/load_impl.rs`.

- **Details**:

  - Create a new helper function that takes the list of missing fields, the
    program name, and the configuration prefix as input.

  - This function will generate the complete error string, including the CLI,
    environment, and file examples for each missing field.

  - The main `load_from_iter` function will call this helper to construct the
    error message.

### Task 5: Add Comprehensive Tests

- **Objective**: Write tests to verify the new error handling behaviour.

- **File to Create**: A new test file in `ortho_config/tests/`, perhaps
  `missing_fields.rs`.

- **Details**:

  - Add a test case where a single required field is missing.

  - Add a test case where multiple required fields are missing, including one
    in a nested struct.

  - Add a `trybuild` compile-fail test to ensure that the error reporting
    integrates correctly with the macro.

  - Verify that the error message content is correctly formatted and contains
    the right information.

By following this design and roadmap, `ortho-config` can be enhanced to provide
a significantly better developer and end-user experience, turning a frustrating
dead-end error into a helpful guide.
